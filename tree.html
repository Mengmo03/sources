<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#4f46e5" />
    <meta name="description" content="B-HU资源分类树和搜索系统" />
    <title>B-HU资源beta 0.5</title>
    <link rel="manifest" href="./manifest.json" />
    <link rel="apple-touch-icon" href="./assets/icon.svg" />
    <script src="./assets/tailwind.css"></script>
    <!-- Lucide Icons -->
    <script src="./assets/lucide.min.js"></script>
    <!-- Papa Parse for CSV parsing -->
    <script src="./assets/papaparse.min.js"></script>
    <!-- Google Fonts and icon.svg will be loaded after page is ready -->
    
    <style>
      /* Font Display Strategy: font-display: swap is enabled via Google Fonts URL parameter */
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', 'Noto Sans SC', sans-serif;
        background-color: #f8fafc;
        color: #1e293b;
        overscroll-behavior: none; 
      }

      /* Custom Scrollbar */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: #94a3b8;
      }

      /* Resource Description Links Styling (Boxed style) */
      .resource-desc a {
        display: inline-block;
        color: #4f46e5; /* indigo-600 */
        background-color: #f5f3ff; /* indigo-50 */
        border: 1px solid #c7d2fe; /* indigo-200 */
        padding: 2px 8px;
        margin: 0 2px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }

      .resource-desc a:hover {
        background-color: #4f46e5;
        color: #ffffff;
        border-color: #4f46e5;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
      }

      /* Tag Count Badge */
      .tag-count-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 1.5rem;
        height: 1.5rem;
        padding: 0 0.4rem;
        border-radius: 9999px;
        background-color: #f1f5f9;
        color: #64748b;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: auto; /* Push to right */
        border: 1px solid #e2e8f0;
      }
      
      /* Header Links Styling */
      .header-link {
        font-size: 0.8rem;
        color: #64748b;
        text-decoration: none;
        transition: color 0.2s;
        cursor: pointer;
      }
      .header-link:hover {
        color: #4f46e5;
        text-decoration: underline;
      }

      /* Utility for hiding elements */
      .hidden { display: none !important; }
      .rotate-90 { transform: rotate(90deg); }
      
      /* Search input text wrapping */
      #search-input {
        word-wrap: break-word;
        word-break: break-word;
        white-space: normal;
        overflow-wrap: break-word;
      }
      
      /* Mobile responsive for search area */
      @media (max-width: 640px) {
        .search-header-container {
          flex-direction: column;
        }
        #strict-match-checkbox-label {
          width: 100%;
          justify-content: center;
          margin-top: 0.5rem;
        }
      }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-slate-50 gap-4">
        <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
        <p class="text-slate-500 font-medium animate-pulse">正在读取分类树...</p>
    </div>

    <!-- Error Screen -->
    <div id="error-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-50 p-4 hidden">
        <div class="bg-white p-8 rounded-xl shadow-xl max-w-md text-center border-l-4 border-rose-500">
            <i data-lucide="alert-circle" class="w-16 h-16 text-rose-500 mx-auto mb-4"></i>
            <h2 class="text-xl font-bold text-slate-800 mb-2">出错了</h2>
            <p id="error-message" class="text-slate-600 mb-6 leading-relaxed"></p>
            <button onclick="window.location.reload()" class="px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition-colors">
                重新加载页面
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="flex h-screen w-screen overflow-hidden bg-slate-50 text-slate-800 font-sans hidden">
        
        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="fixed inset-0 z-40 bg-slate-900/50 backdrop-blur-sm md:hidden transition-opacity hidden" onclick="toggleMobileMenu(false)"></div>

        <!-- SIDEBAR -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-80 bg-white border-r border-slate-200 shadow-2xl md:shadow-none transform transition-transform duration-300 ease-out flex flex-col -translate-x-full md:relative md:translate-x-0">
            <!-- Header -->
            <div class="h-16 flex items-center justify-between px-6 border-b border-slate-100 shrink-0 bg-white">
                <div class="flex items-center gap-2 text-indigo-700 font-bold text-xl tracking-tight">
                    <img id="sidebar-icon" src="./assets/icon.svg" alt="Icon" class="w-5 h-5" />
                    <span>B-HU资源beta 0.5</span>
                </div>
                <button onclick="toggleMobileMenu(false)" class="md:hidden text-slate-400 hover:text-slate-600 p-1 hover:bg-slate-100 rounded-md">
                    <i data-lucide="x" size="20"></i>
                </button>
            </div>

            <!-- Tree Area -->
            <div id="tree-container" class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-0.5">
                <!-- Tree content injected by JS -->
            </div>

            <!-- Footer / Tag Supermarket -->
            <div class="border-t border-slate-200 bg-slate-50 p-4 shrink-0 shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)] z-10">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1">
                        <i data-lucide="tag" class="w-3 h-3"></i> <span id="selected-count">已选标签 (0)</span>
                    </span>
                    <button id="clear-btn" onclick="clearTags()" class="hidden text-xs text-rose-500 hover:text-rose-700 hover:bg-rose-50 px-2 py-1 rounded transition-colors flex items-center gap-1">
                        <i data-lucide="trash-2" class="w-3 h-3"></i> 清空
                    </button>
                </div>
                
                <div id="selected-tags-container" class="flex flex-wrap gap-y-1 gap-x-1 content-start overflow-y-auto custom-scrollbar min-h-[3rem] max-h-[8rem] mb-3 p-2 bg-white border border-slate-200 rounded-lg shadow-sm">
                    <div class="w-full h-full flex items-center justify-center text-slate-300 text-xs italic select-none">
                        查看所有资源...
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col min-w-0 h-full bg-slate-50/50 relative">
            
            <!-- Search Header -->
            <header class="h-auto py-3 bg-white/80 backdrop-blur-md border-b border-slate-200 px-4 md:px-8 flex items-start gap-4 sticky top-0 z-20">
                <button onclick="toggleMobileMenu(true)" class="md:hidden p-2 mt-1 -ml-2 text-slate-500 hover:bg-slate-100 rounded-lg transition-colors">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                
                <!-- Data Loading Notice -->
                <div id="data-loading-notice" class="absolute top-full left-0 right-0 bg-indigo-50 border-b border-indigo-200 px-4 py-2 text-sm text-indigo-700 flex items-center justify-center gap-2 hidden z-30">
                    <div class="w-4 h-4 border-2 border-indigo-400 border-t-indigo-700 rounded-full animate-spin"></div>
                    <span>正在加载资源数据，可能需要约 10 秒...</span>
                </div>
                
                <div class="relative flex-1 max-w-2xl flex flex-col gap-2 search-header-container">
                    <div class="relative w-full flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                        <div class="relative flex-1">
                            <i data-lucide="search" class="absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                            <input 
                                id="search-input"
                                type="text"
                                placeholder="在结果中搜索关键词... (支持繁简自动转换，空格分词)"
                                class="w-full pl-11 pr-4 py-2.5 bg-slate-100 border-transparent focus:bg-white focus:border-indigo-300 focus:ring-4 focus:ring-indigo-50 rounded-xl text-sm transition-all outline-none"
                            />
                        </div>
                        <label id="strict-match-checkbox-label" class="flex items-center justify-center sm:justify-start gap-1.5 text-xs text-slate-600 whitespace-nowrap cursor-pointer bg-white px-3 py-2.5 rounded-xl border border-slate-200 hover:bg-slate-50 transition-colors shrink-0">
                            <input type="checkbox" id="strict-match-checkbox" checked class="w-4 h-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500 cursor-pointer">
                            <span class="select-none">严格匹配</span>
                        </label>
                    </div>
                    
                    <!-- Extra Links -->
                    <div class="flex items-center justify-center gap-1 text-xs text-slate-400 select-none">
                        <a href="./index.html" target="_self" class="header-link">返回首页</a>
                        <span class="text-slate-300">|</span>
                        <a href="https://forms.office.com/r/AMncKSa0ZD" target="_blank" class="header-link">报告错误</a>
                        <span class="text-slate-300">|</span>
                        <a href="#" id="lang-toggle-btn" onclick="toggleLanguage(); return false;" class="header-link text-indigo-500 font-medium">English</a>
                        <button id="install-btn" onclick="installPWA()" class="header-link text-indigo-500 font-medium hidden" style="background: none; border: none; cursor: pointer; padding: 0;"><span class="text-slate-300">|</span>安装为应用</button>
                    </div>
                </div>
                
                <div class="hidden lg:block text-xs text-slate-400 mt-3 text-right">
                    共收录 <span id="total-resource-count">0</span> 条资源<br>
                    <span id="total-tags-count">0</span> 个标签
                </div>
            </header>

            <!-- Content Area -->
            <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-8 custom-scrollbar flex flex-col">
                
                <!-- Welcome State -->
                <div id="welcome-view" class="flex-1 flex flex-col items-center justify-center text-center pb-10 select-none">
                    <img id="welcome-icon" src="./assets/icon.svg" alt="Icon" class="w-24 h-24 mb-8" />
                    <h1 class="text-3xl font-bold text-slate-800 mb-3">B-HU资源beta 0.5</h1>
                    <p class="text-slate-500 max-w-md mx-auto mb-6 leading-relaxed">
                        目前共收录 <span id="hero-resource-count" class="font-bold text-indigo-600">0</span> 条资源<br/>
                        涵盖 <span id="hero-tag-count" class="font-bold text-indigo-600">0</span> 个分类标签
                    </p>
                    <p class="text-slate-400 text-sm max-w-md mx-auto mb-8">
                        请在左侧勾选感兴趣的分类，或者输入关键词开始。
                    </p>
                    <button onclick="toggleMobileMenu(true)" class="md:hidden bg-white text-indigo-600 px-6 py-2.5 rounded-full font-medium shadow-md border border-indigo-100 hover:bg-indigo-50 flex items-center gap-2">
                        <i data-lucide="menu" class="w-4 h-4"></i>
                        打开分类菜单
                    </button>
                </div>

                <!-- Results View -->
                <div id="results-view" class="max-w-7xl mx-auto w-full flex-1 hidden">
                    <div class="flex items-end justify-between mb-6 border-b border-slate-200 pb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">搜索结果</h2>
                            <p id="search-status" class="text-sm text-slate-400 mt-1">全部资源</p>
                        </div>
                        <span id="result-count-badge" class="bg-indigo-50 px-3 py-1 rounded-full text-xs font-bold text-indigo-600">0 条</span>
                    </div>

                    <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-10">
                        <!-- Cards injected here -->
                    </div>

                    <!-- No Results -->
                    <div id="no-results" class="py-20 flex flex-col items-center justify-center text-center hidden">
                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                            <i data-lucide="search" class="text-slate-300 w-8 h-8"></i>
                        </div>
                        <h3 class="text-lg font-medium text-slate-700 mb-1">未找到结果</h3>
                        <p class="text-slate-400 text-sm">尝试选择其他分类或清除关键词</p>
                    </div>
                </div>

                <!-- Footer Stats -->
                <div id="footer-stats" class="mt-auto pt-8 pb-4 text-center border-t border-slate-200/60 w-full">
                    <span id="busuanzi_container_site_pv" style="font-family:Consolas;color:#94a3b8;font-size:12px;margin-right:1rem;">
                        访问量：<span id="busuanzi_value_site_pv" style="font-family:Consolas;color:#64748b;font-weight:600;"></span>
                    </span>
                    <span id="busuanzi_container_site_uv" style="font-family:Consolas;color:#94a3b8;font-size:12px;">
                        访问人数：<span id="busuanzi_value_site_uv" style="font-family:Consolas;color:#64748b;font-weight:600;"></span>
                    </span>
                </div>
            </div>
        </main>
    </div>

    <!-- Back to Top Button -->
    <button 
        id="back-to-top-btn" 
        onclick="scrollToTop()" 
        class="fixed bottom-6 right-6 z-50 p-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center opacity-0 pointer-events-none"
        style="width: 48px; height: 48px; transform: translateY(10px);"
        aria-label="返回顶部"
    >
        <i data-lucide="arrow-up" class="w-5 h-5"></i>
    </button>

<script>
/**
 * State Management
 */
const state = {
    treeData: [],
    jsonData: [], // Renamed from csvData
    selectedTags: new Set(),
    tagDescendants: new Map(),
    nodeCounts: new Map(), // Map<TagName, count>
    searchQuery: "",
    converter: null,
    expandedNodes: new Set(), // Track expanded tree nodes by ID
    strictMatch: true, // Strict match mode (default: true)
    dataLoaded: false // Track if data is loaded
};

// IndexedDB configuration
const DB_NAME = 'bhu-resource-cache';
const DB_VERSION = 1;
const STORE_NAME = 'resourceData';
const CACHE_KEY = 'data.json';
const ETAG_KEY = 'data-etag';

/**
 * Utilities
 */
// Debounce function to limit search execution frequency
function debounce(func, wait) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
    };
}

/**
 * LocalStorage Management
 */
function saveStateToLocalStorage() {
    try {
        const savedState = {
            selectedTags: Array.from(state.selectedTags),
            searchQuery: state.searchQuery,
            strictMatch: state.strictMatch
        };
        localStorage.setItem('bhu-tree-state', JSON.stringify(savedState));
    } catch (e) {
        console.warn('Failed to save state to localStorage:', e);
    }
}

function loadStateFromLocalStorage() {
    try {
        const saved = localStorage.getItem('bhu-tree-state');
        if (saved) {
            const savedState = JSON.parse(saved);
            // Restore selected tags
            if (savedState.selectedTags && Array.isArray(savedState.selectedTags)) {
                state.selectedTags = new Set(savedState.selectedTags);
            }
            // Restore search query
            if (savedState.searchQuery) {
                state.searchQuery = savedState.searchQuery;
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = savedState.searchQuery;
                }
            }
            // Restore strict match mode
            if (typeof savedState.strictMatch === 'boolean') {
                state.strictMatch = savedState.strictMatch;
                const checkbox = document.getElementById('strict-match-checkbox');
                if (checkbox) {
                    checkbox.checked = savedState.strictMatch;
                }
            }
            return true;
        }
    } catch (e) {
        console.warn('Failed to load state from localStorage:', e);
    }
    return false;
}

/**
 * PWA Installation
 */
let deferredPrompt = null;

// 监听 beforeinstallprompt 事件
window.addEventListener('beforeinstallprompt', (e) => {
    // 阻止默认的安装提示
    e.preventDefault();
    // 保存事件以便稍后使用
    deferredPrompt = e;
    // 显示安装按钮
    const installBtn = document.getElementById('install-btn');
    if (installBtn) {
        installBtn.classList.remove('hidden');
    }
});

// 安装 PWA
async function installPWA() {
    if (!deferredPrompt) {
        // 如果事件不存在，可能是已经安装或浏览器不支持
        alert('应用已安装或您的浏览器不支持安装功能');
        return;
    }

    // 显示安装提示
    deferredPrompt.prompt();
    
    // 等待用户响应
    const { outcome } = await deferredPrompt.userChoice;
    
    if (outcome === 'accepted') {
        console.log('用户接受了安装提示');
    } else {
        console.log('用户拒绝了安装提示');
    }
    
    // 清除保存的事件
    deferredPrompt = null;
    
    // 隐藏安装按钮
    const installBtn = document.getElementById('install-btn');
    if (installBtn) {
        installBtn.classList.add('hidden');
    }
}

// 监听应用安装完成事件
window.addEventListener('appinstalled', () => {
    console.log('PWA 已安装');
    deferredPrompt = null;
    const installBtn = document.getElementById('install-btn');
    if (installBtn) {
        installBtn.classList.add('hidden');
    }
});

// 检查是否已安装
if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
    console.log('应用已以独立模式运行');
    const installBtn = document.getElementById('install-btn');
    if (installBtn) {
        installBtn.classList.add('hidden');
    }
}

/**
 * Service Worker Registration
 */
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then((registration) => {
                console.log('Service Worker 注册成功:', registration.scope);
                
                // 检查更新
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // 新版本可用，提示用户刷新
                            if (confirm('发现新版本，是否立即刷新？')) {
                                newWorker.postMessage({ type: 'SKIP_WAITING' });
                                window.location.reload();
                            }
                        }
                    });
                });
            })
            .catch((error) => {
                console.error('Service Worker 注册失败:', error);
            });
    });
}

/**
 * Initialization
 */
document.addEventListener('DOMContentLoaded', async () => {
    lucide.createIcons();
    
    try {
        // Step 1: Load tree data (fenlei.md) first
        await loadTreeData();
        
        // Load state from localStorage before initializing UI
        loadStateFromLocalStorage();
        initEventListeners();
        renderTree(); // Initial render (collapsed)
        
        // Update counts for tree (resource count will be 0 until data is loaded)
        const totalTags = countTreeNodes(state.treeData);
        document.getElementById('total-tags-count').textContent = totalTags;
        document.getElementById('hero-tag-count').textContent = totalTags;
        
        // Restore UI state after rendering
        updateSelectionUI();
        
        // Hide loading screen and show app
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        
        // Load icon immediately (don't wait for window.load)
        loadIcon().catch(e => console.warn('Icon loading failed:', e));
        
        // Initialize back to top button icon after app is shown
        setTimeout(() => {
            lucide.createIcons();
            updateBackToTopButton();
        }, 100);
        
        // Step 2: Load resource data asynchronously (lazy loading)
        loadResourceData().then(() => {
            // Start periodic update check after initial load
            startPeriodicUpdateCheck();
        }).catch(e => {
            console.error('Failed to load resource data:', e);
            const loadingNotice = document.getElementById('data-loading-notice');
            if (loadingNotice) loadingNotice.classList.add('hidden');
            
            // Show error but don't block the UI
            const errorMsg = document.createElement('div');
            errorMsg.className = 'fixed top-4 right-4 bg-rose-100 border border-rose-300 text-rose-800 px-4 py-2 rounded-lg shadow-lg z-50 text-sm';
            errorMsg.textContent = '资源数据加载失败，请刷新页面重试';
            document.body.appendChild(errorMsg);
            setTimeout(() => errorMsg.remove(), 5000);
        });
        
        // Lazy load non-critical features after page is shown
        // Load in sequence: opencc -> fonts -> busuanzi -> icon.svg
        window.addEventListener('load', () => {
            loadResourcesSequentially();
        });
    } catch (e) {
        console.error(e);
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('error-screen').classList.remove('hidden');
        document.getElementById('error-message').textContent = "分类树加载失败，请确保目录下存在 fenlei.md";
    }
});

// Language Translation Logic (Lazy Load)
function initTranslate() {
    if (window._translateLoading) return;
    window._translateLoading = true;
    const script = document.createElement("script");
    script.src = "https://res.zvo.cn/translate/translate.js";
    script.defer = true;
    script.onload = () => {
        if (!window.translate) {
            console.error("Translate library loaded without exposing global.");
            return;
        }
        translate.setUseVersion2();
        translate.selectLanguageTag.show = false;
        // Set initial language to simplified chinese (local)
        translate.language.setLocal("chinese_simplified"); 
        translate.listener.start();
        window._translateReady = true;
    };
    script.onerror = () => {
        console.error("Failed to load translate.js");
    };
    document.head.appendChild(script);
}

// Busuanzi Stats (Lazy Load)
function initBusuanzi() {
    if (document.getElementById('busuanzi_script')) return;
    const script = document.createElement("script");
    script.id = 'busuanzi_script';
    script.async = true;
    script.src = "//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js";
    document.head.appendChild(script);
}

function toggleLanguage() {
    if (!window.translate || !window._translateReady) {
        alert("页面翻译功能还在加载，请稍后再试。");
        return;
    }

    const btn = document.getElementById('lang-toggle-btn');
    const currentLang = translate.language.getLocal();

    if (currentLang === 'chinese_simplified') {
        translate.changeLanguage('english');
        btn.textContent = '简体中文';
    } else {
        translate.changeLanguage('chinese_simplified');
        btn.textContent = 'English';
    }
}

// Load resources sequentially after page is ready
async function loadResourcesSequentially() {
    try {
        // Step 1: Load OpenCC first (priority) - 失败不影响页面
        await initOpenCC().catch(e => console.warn('OpenCC load failed:', e));
        
        // Step 2: Load fonts - 失败不影响页面（使用系统字体）
        await loadFonts().catch(e => console.warn('Fonts load failed:', e));
        
        // Step 3: Load translate script - 失败不影响页面（翻译功能可选）
        try {
            initTranslate();
        } catch (e) {
            console.warn('Translate init failed:', e);
        }
        
        // Step 4: Load busuanzi - 失败不影响页面（统计功能可选）
        try {
            initBusuanzi();
        } catch (e) {
            console.warn('Busuanzi init failed:', e);
        }
        
        // Step 5: Icon is already loaded in DOMContentLoaded, skip here
    } catch (e) {
        console.warn('Failed to load some resources:', e);
        // 即使所有资源加载失败，页面也应该能正常显示
    }
}

async function initOpenCC() {
    if (window._openccLoading) {
        // Wait for existing loading to complete
        return new Promise((resolve) => {
            const checkInterval = setInterval(() => {
                if (state.converter) {
                    clearInterval(checkInterval);
                    resolve();
                }
            }, 50);
            setTimeout(() => {
                clearInterval(checkInterval);
                resolve(); // Resolve anyway after 5 seconds
            }, 5000);
        });
    }
    window._openccLoading = true;
    
    return new Promise((resolve, reject) => {
        // Lazy load OpenCC script
        if (!window.OpenCC) {
            const script = document.createElement("script");
            script.src = "./assets/full.js";
            script.onload = async () => {
                if (window.OpenCC) {
                    try {
                        const cvtS2T = await window.OpenCC.Converter({ from: 'cn', to: 'hk' });
                        const cvtT2S = await window.OpenCC.Converter({ from: 'hk', to: 'cn' });
                        state.converter = { s2t: cvtS2T, t2s: cvtT2S };
                        resolve();
                    } catch (e) {
                        console.warn("OpenCC init failed", e);
                        reject(e);
                    }
                } else {
                    reject(new Error("OpenCC not available"));
                }
            };
            script.onerror = () => reject(new Error("Failed to load OpenCC script"));
            document.head.appendChild(script);
        } else {
            // OpenCC already loaded
            (async () => {
                try {
                    const cvtS2T = await window.OpenCC.Converter({ from: 'cn', to: 'hk' });
                    const cvtT2S = await window.OpenCC.Converter({ from: 'hk', to: 'cn' });
                    state.converter = { s2t: cvtS2T, t2s: cvtT2S };
                    resolve();
                } catch (e) {
                    console.warn("OpenCC init failed", e);
                    reject(e);
                }
            })();
        }
    });
}

// Load Google Fonts
function loadFonts() {
    return new Promise((resolve) => {
        if (document.getElementById('google-fonts-link')) {
            resolve();
            return;
        }
        
        // Preconnect first (忽略失败)
        const preconnect = document.createElement('link');
        preconnect.rel = 'preconnect';
        preconnect.href = 'https://gstatic.qaq.qa';
        document.head.appendChild(preconnect);
        
        // Load font stylesheet
        const link = document.createElement('link');
        link.id = 'google-fonts-link';
        link.rel = 'stylesheet';
        link.href = 'https://gstatic.qaq.qa/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap';
        link.onload = () => resolve();
        // 字体加载失败不影响页面，使用系统字体即可
        link.onerror = () => {
            console.warn('Failed to load Google Fonts, using system fonts');
            resolve(); // 不 reject，让页面继续加载
        };
        document.head.appendChild(link);
    });
}

// Load icon.svg only once and apply to all places
function loadIcon() {
    return new Promise((resolve, reject) => {
        if (window._iconLoaded) {
            resolve();
            return;
        }
        
        const iconUrl = './assets/icon.svg';
        
        // Set favicon immediately (SVG can be set directly)
        const existingFavicon = document.querySelector('link[rel="icon"]');
        if (existingFavicon) {
            existingFavicon.remove();
        }
        const favicon = document.createElement('link');
        favicon.rel = 'icon';
        favicon.href = iconUrl;
        favicon.type = 'image/svg+xml';
        document.head.appendChild(favicon);
        
        // Verify images are loaded (they should already have src set in HTML)
        const sidebarIcon = document.getElementById('sidebar-icon');
        const welcomeIcon = document.getElementById('welcome-icon');
        
        // Check if images are already loaded or need to be verified
        let loadedCount = 0;
        const totalImages = (sidebarIcon ? 1 : 0) + (welcomeIcon ? 1 : 0);
        
        if (totalImages === 0) {
            window._iconLoaded = true;
            resolve();
            return;
        }
        
        const checkComplete = () => {
            loadedCount++;
            if (loadedCount >= totalImages) {
                window._iconLoaded = true;
                resolve();
            }
        };
        
        // Verify sidebar icon
        if (sidebarIcon) {
            if (sidebarIcon.complete && sidebarIcon.naturalHeight !== 0) {
                checkComplete();
            } else {
                sidebarIcon.onload = checkComplete;
                sidebarIcon.onerror = () => {
                    console.warn('Failed to load sidebar icon');
                    checkComplete(); // Continue anyway
                };
            }
        }
        
        // Verify welcome icon
        if (welcomeIcon) {
            if (welcomeIcon.complete && welcomeIcon.naturalHeight !== 0) {
                checkComplete();
            } else {
                welcomeIcon.onload = checkComplete;
                welcomeIcon.onerror = () => {
                    console.warn('Failed to load welcome icon');
                    checkComplete(); // Continue anyway
                };
            }
        }
    });
}

function updateCounts() {
    const totalRes = state.jsonData.length;
    const totalTags = countTreeNodes(state.treeData);
    document.getElementById('total-resource-count').textContent = totalRes;
    document.getElementById('total-tags-count').textContent = totalTags;
    document.getElementById('hero-resource-count').textContent = totalRes;
    document.getElementById('hero-tag-count').textContent = totalTags;
}

function countTreeNodes(nodes) {
    let count = 0;
    nodes.forEach(node => {
        count++; // Count self
        if (node.children && node.children.length > 0) {
            count += countTreeNodes(node.children);
        }
    });
    return count;
}

/**
 * IndexedDB Management
 */
function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME);
            }
        };
    });
}

async function getCachedData() {
    try {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(CACHE_KEY);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
        });
    } catch (e) {
        console.warn('Failed to read from IndexedDB:', e);
        return null;
    }
}

async function saveDataToCache(data, etag) {
    try {
        const db = await openDB();
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        
        // Save data
        await new Promise((resolve, reject) => {
            const request = store.put(data, CACHE_KEY);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve();
        });
        
        // Save ETag if provided
        if (etag) {
            await new Promise((resolve, reject) => {
                const request = store.put(etag, ETAG_KEY);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve();
            });
        }
        
        console.log('Data saved to IndexedDB cache');
    } catch (e) {
        console.warn('Failed to save to IndexedDB:', e);
    }
}

async function getCachedETag() {
    try {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(ETAG_KEY);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
        });
    } catch (e) {
        console.warn('Failed to read ETag from IndexedDB:', e);
        return null;
    }
}

/**
 * Data Parsing & Loading
 */
async function loadTreeData() {
    // Load fenlei.md first (synchronous-like, but async)
    try {
        const mdRes = await fetch("./data/fenlei.md");
        if (!mdRes.ok) {
            throw new Error(`Failed to fetch fenlei.md: ${mdRes.status}`);
        }
        
        const mdText = await mdRes.text();
        state.treeData = parseMarkdownTree(mdText);
        state.tagDescendants = buildDescendantMap(state.treeData);
    } catch (e) {
        // 离线回退：尝试从 Service Worker 缓存读取
        console.warn('Failed to load fenlei.md from network, trying cache:', e);
        try {
            const cache = await caches.open('bhu-resource-v1');
            const cachedResponse = await cache.match('./data/fenlei.md');
            if (cachedResponse) {
                const mdText = await cachedResponse.text();
                state.treeData = parseMarkdownTree(mdText);
                state.tagDescendants = buildDescendantMap(state.treeData);
                console.log('Loaded fenlei.md from cache');
                return;
            }
        } catch (cacheError) {
            console.error('Failed to load from cache:', cacheError);
        }
        // 如果缓存也失败，抛出错误
        throw new Error("Failed to fetch fenlei.md and no cache available");
    }
}

async function loadResourceData() {
    // Show loading notice
    const loadingNotice = document.getElementById('data-loading-notice');
    if (loadingNotice) {
        loadingNotice.classList.remove('hidden');
    }
    
    try {
        // Try to load from IndexedDB cache first
        const cachedData = await getCachedData();
        const cachedETag = await getCachedETag();
        
        // Prepare fetch options with conditional request
        const fetchOptions = {};
        if (cachedETag) {
            fetchOptions.headers = {
                'If-None-Match': cachedETag
            };
        }
        
        // Fetch CSV from server (Service Worker will handle caching)
        let csvRes;
        try {
            csvRes = await fetch("./data/data.csv", fetchOptions);
        } catch (fetchError) {
            // 网络错误，尝试从 Service Worker 缓存读取
            console.warn('Network fetch failed, trying Service Worker cache:', fetchError);
            if (cachedData) {
                // 如果有 IndexedDB 缓存，直接使用
                console.log('Using IndexedDB cached data (offline mode)');
                state.jsonData = cachedData;
                processResourceData();
                if (loadingNotice) loadingNotice.classList.add('hidden');
                return;
            }
            
            // 尝试从 Service Worker 缓存读取原始 CSV
            try {
                const cache = await caches.open('bhu-resource-v1');
                const cachedCsvResponse = await cache.match('./data/data.csv');
                if (cachedCsvResponse) {
                    const csvText = await cachedCsvResponse.text();
                    const parsedData = parseCSV(csvText);
                    state.jsonData = parsedData;
                    processResourceData();
                    // 保存到 IndexedDB 以便下次使用
                    await saveDataToCache(state.jsonData, null);
                    if (loadingNotice) loadingNotice.classList.add('hidden');
                    console.log('Loaded data.csv from Service Worker cache (offline mode)');
                    return;
                }
            } catch (cacheError) {
                console.error('Failed to load from Service Worker cache:', cacheError);
            }
            
            // 如果所有缓存都失败，抛出错误
            throw new Error("Failed to fetch data.csv and no cache available");
        }
        
        if (csvRes.status === 304 && cachedData) {
            // Not modified, use cached data
            console.log('Using cached data (304 Not Modified)');
            state.jsonData = cachedData;
            processResourceData();
            if (loadingNotice) loadingNotice.classList.add('hidden');
            return;
        }
        
        if (!csvRes.ok) {
            if (cachedData) {
                // Use cached data as fallback
                console.log('Fetch failed, using cached data');
                state.jsonData = cachedData;
                processResourceData();
                if (loadingNotice) loadingNotice.classList.add('hidden');
                return;
            }
            throw new Error("Failed to fetch data.csv");
        }
        
        const csvText = await csvRes.text();
        const etag = csvRes.headers.get('ETag') || csvRes.headers.get('etag');
        
        // Parse CSV using Papa Parse
        const parsedData = parseCSV(csvText);
        state.jsonData = parsedData;
        processResourceData();
        
        // Save to cache
        await saveDataToCache(state.jsonData, etag);
        
        // Hide loading notice
        if (loadingNotice) loadingNotice.classList.add('hidden');
        
        console.log('Resource data loaded successfully');
    } catch (e) {
        console.error('Failed to load resource data:', e);
        
        // Try to use cached data as fallback
        const cachedData = await getCachedData();
        if (cachedData) {
            console.log('Using cached data as fallback');
            state.jsonData = cachedData;
            processResourceData();
            if (loadingNotice) loadingNotice.classList.add('hidden');
            return;
        }
        
        // 最后尝试从 Service Worker 缓存读取
        try {
            const cache = await caches.open('bhu-resource-v1');
            const cachedCsvResponse = await cache.match('./data/data.csv');
            if (cachedCsvResponse) {
                const csvText = await cachedCsvResponse.text();
                const parsedData = parseCSV(csvText);
                state.jsonData = parsedData;
                processResourceData();
                await saveDataToCache(state.jsonData, null);
                if (loadingNotice) loadingNotice.classList.add('hidden');
                console.log('Loaded data.csv from Service Worker cache as last resort');
                return;
            }
        } catch (cacheError) {
            console.error('Failed to load from Service Worker cache:', cacheError);
        }
        
        // If no cache and fetch failed, show error
        if (loadingNotice) loadingNotice.classList.add('hidden');
        throw e;
    }
}

function processResourceData() {
    // Calculate recursive counts for tree visualization
    state.nodeCounts = calculateRecursiveCounts(state.treeData, state.jsonData);
    state.dataLoaded = true;
    
    // Update counts UI
    updateCounts();
    
    // Re-render tree to update counts
    renderTree();
    
    // If there were saved searches, execute them
    if (state.selectedTags.size > 0 || state.searchQuery) {
        executeSearch();
    }
}

// Periodic update check (every 5 minutes)
let updateCheckInterval = null;

function startPeriodicUpdateCheck() {
    // Clear existing interval if any
    if (updateCheckInterval) {
        clearInterval(updateCheckInterval);
    }
    
    // Check for updates every 24 hours
    updateCheckInterval = setInterval(async () => {
        await checkForDataUpdates();
    }, 24 * 60 * 60 * 1000); // 24 hours
}

async function checkForDataUpdates() {
    try {
        const cachedETag = await getCachedETag();
        if (!cachedETag) return;
        
        // Check if server has newer data
        const fetchOptions = {
            method: 'HEAD', // Only fetch headers to save bandwidth
            headers: {
                'If-None-Match': cachedETag
            }
        };
        
        const response = await fetch("./data/data.csv", fetchOptions);
        
        // If 304, no update needed
        if (response.status === 304) {
            console.log('Data is up to date');
            return;
        }
        
        // If not 304, update available - reload data silently
        if (response.ok || response.status !== 404) {
            console.log('Update detected, reloading data...');
            await loadResourceDataSilently();
        }
    } catch (e) {
        // Silently fail - don't interrupt user experience
        console.debug('Update check failed:', e);
    }
}

async function loadResourceDataSilently() {
    try {
        const cachedETag = await getCachedETag();
        
        const fetchOptions = {};
        if (cachedETag) {
            fetchOptions.headers = {
                'If-None-Match': cachedETag
            };
        }
        
        const csvRes = await fetch("./data/data.csv", fetchOptions);
        
        if (csvRes.status === 304) {
            return; // No update
        }
        
        if (!csvRes.ok) {
            return; // Failed, keep using cached data
        }
        
        const csvText = await csvRes.text();
        const etag = csvRes.headers.get('ETag') || csvRes.headers.get('etag');
        
        // Parse CSV using Papa Parse
        const parsedData = parseCSV(csvText);
        const oldDataLength = state.jsonData.length;
        
        // Update data
        state.jsonData = parsedData;
        processResourceData();
        await saveDataToCache(state.jsonData, etag);
        console.log('Data updated silently', { oldLength: oldDataLength, newLength: state.jsonData.length });
    } catch (e) {
        console.debug('Silent update failed:', e);
    }
}

// Legacy function name for backward compatibility
async function loadData() {
    await loadTreeData();
    // Resource data will be loaded lazily after page is shown
}

function calculateRecursiveCounts(treeData, jsonData) {
    // 1. Map direct counts: TagName -> Set of indices
    const tagDirectItems = new Map();
    
    jsonData.forEach((item, index) => {
        if (item.tags) {
            item.tags.forEach(tag => {
                if (!tagDirectItems.has(tag)) {
                    tagDirectItems.set(tag, new Set());
                }
                tagDirectItems.get(tag).add(index);
            });
        }
    });

    // 2. Recursive aggregation
    const counts = new Map();

    function processNode(nodes) {
        const branchItems = new Set(); // Items in this branch (self + children)

        nodes.forEach(node => {
            const nodeItems = new Set(tagDirectItems.get(node.name) || []);
            
            if (node.children && node.children.length > 0) {
                const childItems = processNode(node.children);
                childItems.forEach(i => nodeItems.add(i));
            }

            // Store the unique count for this node (including its children)
            counts.set(node.name, nodeItems.size);

            // Add to parent branch
            nodeItems.forEach(i => branchItems.add(i));
        });

        return branchItems;
    }

    processNode(treeData);
    return counts;
}

function parseMarkdownTree(md) {
    const normalizedMd = md.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
    const lines = normalizedMd.split("\n");
    const root = [];
    const stack = [];

    lines.forEach((line, index) => {
        if (!line.trim()) return;
        const match = line.match(/^([\t ]*)([-*+])\s+(.+)$/);
        if (!match) return;

        const rawIndent = match[1];
        const indent = rawIndent.replace(/\t/g, "    ").length;
        let rawContent = match[3].trim();
        let name = rawContent;
        let comment = "";

        const commentMatch = rawContent.match(/<!--([\s\S]*?)-->/);
        if (commentMatch) {
            let cText = commentMatch[1].trim();
            if (cText.startsWith("注释:{") && cText.endsWith("}")) {
                cText = cText.substring(4, cText.length - 1);
            }
            comment = cText;
            name = rawContent.replace(/<!--[\s\S]*?-->/, "").trim();
        }

        if (!name) return;

        const node = {
            id: `node-${index}`,
            name,
            comment,
            children: [],
            level: 0
        };

        while (stack.length > 0 && stack[stack.length - 1].indent >= indent) {
            stack.pop();
        }

        if (stack.length === 0) {
            root.push(node);
            node.level = 0;
        } else {
            const parent = stack[stack.length - 1].node;
            parent.children.push(node);
            node.level = parent.level + 1;
        }

        stack.push({ node, indent });
    });
    return root;
}

function parseCSV(csvText) {
    if (!window.Papa) {
        console.error('Papa Parse library not loaded');
        return [];
    }
    
    // Parse CSV using Papa Parse
    const result = Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        transformHeader: (header) => {
            // Normalize header names
            return header.trim();
        }
    });
    
    if (result.errors && result.errors.length > 0) {
        console.warn('CSV parsing errors:', result.errors);
    }
    
    // Process parsed data
    return result.data.map(item => {
        // Ensure tags is an array
        // Tags in CSV are comma-separated strings, need to split them
        if (typeof item.tags === 'string') {
            item.tags = item.tags.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
        } else if (!Array.isArray(item.tags)) {
            item.tags = [];
        }
        
        // PRE-PROCESS SEARCH STRING for performance
        // Concatenate title, desc, tags and lowercase them once.
        const title = (item.title || item.name || "");
        const desc = (item.description || item.desc || "");
        const tagStr = item.tags.join(" ");
        item._searchStr = `${title} ${desc} ${tagStr}`.toLowerCase();
        
        return item;
    });
}

// Legacy function for backward compatibility (if needed)
function parseJSON(jsonArray) {
    if (!Array.isArray(jsonArray)) return [];
    
    return jsonArray.map(item => {
        // Ensure tags is an array
        if (!Array.isArray(item.tags)) {
            item.tags = [];
        }
        
        // PRE-PROCESS SEARCH STRING for performance
        // Concatenate title, desc, tags and lowercase them once.
        const title = (item.title || item.name || "");
        const desc = (item.description || item.desc || "");
        const tagStr = item.tags.join(" ");
        item._searchStr = `${title} ${desc} ${tagStr}`.toLowerCase();
        
        return item;
    });
}

function buildDescendantMap(nodes) {
    const map = new Map();
    const traverse = (node) => {
        const descendants = new Set();
        node.children.forEach(child => {
            descendants.add(child.name);
            const childDescendants = traverse(child);
            childDescendants.forEach(d => descendants.add(d));
        });
        map.set(node.name, descendants);
        return descendants;
    };
    nodes.forEach(node => traverse(node));
    return map;
}

/**
 * UI Rendering: Sidebar Tree
 */
function renderTree() {
    const container = document.getElementById('tree-container');
    
    // Use DocumentFragment for performance
    const fragment = document.createDocumentFragment();

    // 'All' Node
    const allSelected = state.selectedTags.size === 0;
    const allNode = document.createElement('div');
    allNode.innerHTML = `
        <div class="flex items-center py-2 px-2 rounded-md transition-all duration-200 hover:bg-slate-100 cursor-pointer mb-2 ${allSelected ? 'bg-indigo-50/50' : ''}">
            <div class="w-4 mr-1"></div>
            <div class="mr-2 ${allSelected ? 'text-indigo-600' : 'text-slate-400'}">
                <i data-lucide="${allSelected ? 'check-square' : 'square'}" class="w-4 h-4"></i>
            </div>
            <div class="font-bold ${allSelected ? 'text-indigo-700' : 'text-slate-800'}">全部</div>
        </div>
        <div class="border-b border-slate-100 my-2"></div>
    `;
    // Bind click directly
    allNode.firstElementChild.onclick = () => clearTags();
    fragment.appendChild(allNode);

    // Recursive Tree
    state.treeData.forEach(node => {
        fragment.appendChild(createTreeNode(node));
    });

    container.innerHTML = '';
    container.appendChild(fragment);

    lucide.createIcons();
}

function createTreeNode(node) {
    const isSelected = state.selectedTags.has(node.name);
    const isExpanded = state.expandedNodes.has(node.id);
    const hasChildren = node.children && node.children.length > 0;
    const count = state.nodeCounts.get(node.name) || 0;
    
    const wrapper = document.createElement('div');
    wrapper.className = "select-none text-sm mb-1";

    // Node Row
    const row = document.createElement('div');
    row.className = "relative group";
    row.style.marginLeft = `${node.level * 16}px`;

    const inner = document.createElement('div');
    inner.className = `flex items-start py-1.5 px-2 rounded-md transition-all duration-200 hover:bg-slate-100 ${isSelected ? 'bg-indigo-50/50' : ''}`;

    // Toggle Expand Handler
    const toggleExpand = (e) => {
        if (e && e.target && e.target.closest('.tree-checkbox-container')) {
            // Don't expand if clicking on checkbox
            return;
        }
        if (hasChildren) {
            if (state.expandedNodes.has(node.id)) {
                state.expandedNodes.delete(node.id);
            } else {
                state.expandedNodes.add(node.id);
            }
            renderTree(); 
        }
    };

    // Toggle Select Handler
    const toggleSelect = (e) => {
        if (e) {
            e.stopPropagation();
            e.preventDefault();
        }
        toggleTag(node.name);
    };

    // Make the entire inner div clickable for expand/collapse (except checkbox)
    // If no children, clicking will toggle selection instead
    inner.onclick = hasChildren ? toggleExpand : toggleSelect;
    inner.style.cursor = hasChildren ? 'pointer' : 'pointer';

    // Chevron
    const chevronContainer = document.createElement('div');
    chevronContainer.className = `mr-1 text-slate-400 transition-transform duration-200 hover:text-slate-600 flex-shrink-0 flex items-start pt-0.5 ${isExpanded ? 'rotate-90' : ''} ${hasChildren ? '' : 'opacity-0 pointer-events-none'}`;
    chevronContainer.innerHTML = `<i data-lucide="chevron-right" class="w-4 h-4"></i>`;
    // Remove individual onclick since inner div handles it

    // Checkbox
    const checkboxContainer = document.createElement('div');
    checkboxContainer.className = `tree-checkbox-container mr-2 cursor-pointer flex-shrink-0 transition-colors flex items-start pt-0.5 ${isSelected ? 'text-indigo-600' : 'text-slate-300 hover:text-indigo-400'}`;
    checkboxContainer.innerHTML = `<i data-lucide="${isSelected ? 'check-square' : 'square'}" class="w-4 h-4"></i>`;
    checkboxContainer.onclick = toggleSelect;

    // Content
    const content = document.createElement('div');
    content.className = "flex flex-1 items-start min-w-0 mr-2";
    
    const title = document.createElement('span');
    title.className = `font-medium leading-5 break-words ${isSelected ? 'text-indigo-700' : 'text-slate-700'}`;
    title.textContent = node.name;
    // Remove individual onclick since inner div handles it

    content.appendChild(title);

    // Count Badge
    const countBadge = document.createElement('span');
    countBadge.className = "tag-count-badge flex-shrink-0 mt-0.5";
    countBadge.textContent = count;
    
    inner.appendChild(chevronContainer);
    inner.appendChild(checkboxContainer);
    inner.appendChild(content);
    inner.appendChild(countBadge);

    row.appendChild(inner);
    wrapper.appendChild(row);

    // Comments (Render below row if exists)
    if (node.comment) {
        const comment = document.createElement('div');
        comment.className = "text-xs text-slate-500 mt-1 mb-1 pl-2";
        comment.style.marginLeft = `${(node.level * 16) + 24}px`;
        comment.style.lineHeight = '1.5';
        // Parse HTML tags in comment and preserve line breaks
        const commentHtml = node.comment.replace(/\n/g, '<br/>');
        comment.innerHTML = commentHtml;
        wrapper.appendChild(comment);
    }

    // Children
    if (isExpanded && hasChildren) {
        const childrenContainer = document.createElement('div');
        childrenContainer.className = "mt-0.5";
        node.children.forEach(child => {
            childrenContainer.appendChild(createTreeNode(child));
        });
        wrapper.appendChild(childrenContainer);
    }

    return wrapper;
}

/**
 * Logic: Selection & Search
 */
function toggleTag(tag) {
    if (state.selectedTags.has(tag)) {
        state.selectedTags.delete(tag);
    } else {
        state.selectedTags.add(tag);
    }
    saveStateToLocalStorage(); // Save to localStorage
    updateSelectionUI();
    executeSearch(); // Trigger search immediately
}

function clearTags() {
    state.selectedTags.clear();
    saveStateToLocalStorage(); // Save to localStorage
    updateSelectionUI();
    executeSearch(); // Trigger search immediately
}

function updateSelectionUI() {
    renderTree();
    
    const container = document.getElementById('selected-tags-container');
    const countSpan = document.getElementById('selected-count');
    const clearBtn = document.getElementById('clear-btn');

    countSpan.textContent = `已选标签 (${state.selectedTags.size})`;
    
    if (state.selectedTags.size === 0) {
        container.innerHTML = `<div class="w-full h-full flex items-center justify-center text-slate-300 text-xs italic select-none">查看所有资源...</div>`;
        clearBtn.classList.add('hidden');
    } else {
        clearBtn.classList.remove('hidden');
        container.innerHTML = '';
        state.selectedTags.forEach(tag => {
            const chip = document.createElement('span');
            chip.className = "inline-flex items-center bg-indigo-50 text-indigo-700 text-xs font-medium px-2.5 py-1 rounded-md mr-2 mb-2 border border-indigo-100 group hover:bg-indigo-100 transition-colors";
            chip.innerHTML = `
                ${tag}
                <button class="ml-1.5 text-indigo-400 hover:text-indigo-800 focus:outline-none" onclick="toggleTag('${tag}')">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            `;
            container.appendChild(chip);
        });
        lucide.createIcons();
    }
}

// Debounced search execution
const debouncedSearch = debounce(() => {
    executeSearch();
}, 300);

async function executeSearch() {
    // Mobile close if needed (optional logic check could be added here to only close if query is distinct)
    // if (window.innerWidth < 768) toggleMobileMenu(false);

    const input = document.getElementById('search-input');
    const rawQuery = input.value.trim();
    state.searchQuery = rawQuery;
    saveStateToLocalStorage(); // Save to localStorage

    // If no tags and no query, show welcome screen
    if (state.selectedTags.size === 0 && !rawQuery) {
        document.getElementById('welcome-view').classList.remove('hidden');
        document.getElementById('results-view').classList.add('hidden');
        return;
    }

    // Effective Tags (Parent includes children)
    const effectiveTags = new Set();
    state.selectedTags.forEach(t => {
        effectiveTags.add(t);
        const children = state.tagDescendants.get(t);
        if (children) children.forEach(child => effectiveTags.add(child));
    });

    // Keyword handling with space-separated terms
    let searchTerms = [];
    if (rawQuery) {
        // Split by spaces to support multiple keywords
        const rawTerms = rawQuery.split(/\s+/).filter(t => t.length > 0);
        
        // Process each term with OpenCC conversion
        for (const rawTerm of rawTerms) {
            const termVariants = [rawTerm.toLowerCase()];
            // Attempt OpenCC if available
            if (state.converter) {
                try {
                    const s2t = await state.converter.s2t(rawTerm);
                    const t2s = await state.converter.t2s(rawTerm);
                    if (s2t !== rawTerm) termVariants.push(s2t.toLowerCase());
                    if (t2s !== rawTerm) termVariants.push(t2s.toLowerCase());
                } catch(e) { console.error(e); }
            }
            searchTerms.push(termVariants);
        }
    }

    // Filter (Optimized Loop)
    const hasTags = state.selectedTags.size > 0;
    const hasQuery = searchTerms.length > 0;

    // Wait for data to be loaded
    if (!state.dataLoaded) {
        // Show welcome view if data is not loaded yet
        document.getElementById('welcome-view').classList.remove('hidden');
        document.getElementById('results-view').classList.add('hidden');
        return;
    }
    
    const results = state.jsonData.filter(item => {
        // 1. Tag Match (Fastest check first)
        if (hasTags) {
            if (!item.tags || item.tags.length === 0) return false;
            // Using effectiveTags Set for O(1) lookup per tag
            const matchesTag = item.tags.some(t => effectiveTags.has(t));
            if (!matchesTag) return false;
        }

        // 2. Keyword Match with strict/loose mode
        if (hasQuery) {
            if (state.strictMatch) {
                // Strict mode: all terms must match
                const allTermsMatch = searchTerms.every(termVariants => 
                    termVariants.some(term => item._searchStr.includes(term))
                );
                if (!allTermsMatch) return false;
            } else {
                // Loose mode: any term matches
                const anyTermMatches = searchTerms.some(termVariants => 
                    termVariants.some(term => item._searchStr.includes(term))
                );
                if (!anyTermMatches) return false;
            }
        }

        return true;
    });

    renderResults(results);
}

/**
 * UI Rendering: Results
 */
function renderResults(results) {
    document.getElementById('welcome-view').classList.add('hidden');
    document.getElementById('results-view').classList.remove('hidden');

    const grid = document.getElementById('results-grid');
    const noResults = document.getElementById('no-results');
    const badge = document.getElementById('result-count-badge');
    const status = document.getElementById('search-status');

    badge.textContent = `${results.length} 条`;
    
    let statusText = state.selectedTags.size > 0 ? `包含标签: ${Array.from(state.selectedTags).join(", ")}` : "全部资源";
    if (state.searchQuery) statusText += ` + 关键词: "${state.searchQuery}"`;
    status.textContent = statusText;

    if (results.length === 0) {
        grid.innerHTML = '';
        noResults.classList.remove('hidden');
    } else {
        noResults.classList.add('hidden');
        
        // CRITICAL PERFORMANCE FIX: Map to strings then join, set innerHTML once
        // This avoids N reflows/repaints
        const htmlBuffer = results.map(item => generateCardHtml(item));
        grid.innerHTML = htmlBuffer.join('');
        
        // Only create icons after bulk insertion
        lucide.createIcons();
    }
}

function generateCardHtml(item) {
    const title = item.title || item.name || Object.values(item)[0] || "无标题";
    const desc = item.description || item.desc || item.summary || "";
    const link = item.link || item.url || "#";
    const safeLink = link.startsWith("http") ? link : `http://${link}`;
    const tags = item.tags || [];
    
    // Heuristic for long text (approx 100 chars)
    const isLongText = desc.length > 100;
    // Random ID only generated when needed, or use a deterministic one if preferred
    const cardId = 'card-' + Math.random().toString(36).substr(2, 9);

    let tagsHtml = tags.length > 0 
        ? tags.slice(0,3).map(t => `<span class="text-[10px] font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded whitespace-nowrap border border-slate-200">${t}</span>`).join('')
        : `<span class="text-[10px] text-slate-300">无标签</span>`;
    
    if (tags.length > 3) tagsHtml += `<span class="text-[10px] text-slate-400 py-1">+ ${tags.length - 3}</span>`;

    return `
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-md hover:border-indigo-300 transition-all duration-300 flex flex-col h-full overflow-hidden group">
      <div class="p-5 flex-1 flex flex-col">
        <div class="flex justify-between items-start gap-3 mb-2">
          <h3 class="font-bold text-slate-800 text-lg leading-snug select-text">${title}</h3>
        </div>
        
        <div class="flex-1 mb-4">
            ${desc ? `
                <div>
                    <div id="${cardId}-text" class="resource-desc text-slate-500 text-sm leading-relaxed text-justify select-text break-words line-clamp-4">
                        ${desc}
                    </div>
                    ${isLongText ? `
                        <button onclick="toggleCardDesc('${cardId}')" id="${cardId}-btn" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium mt-2 flex items-center gap-0.5 focus:outline-none transition-colors p-1 hover:bg-indigo-50 rounded">
                            展开更多 <i data-lucide="chevron-down" class="w-3 h-3"></i>
                        </button>
                    ` : ''}
                </div>
            ` : `<p class="text-slate-300 text-sm italic">暂无描述</p>`}
        </div>

        <div class="mt-auto pt-4 border-t border-slate-100 flex items-end justify-between gap-3">
             <div class="flex flex-wrap gap-1.5 flex-1 min-w-0">
                ${tagsHtml}
             </div>
             <a href="${safeLink}" target="_blank" rel="noreferrer" class="shrink-0 flex items-center gap-1.5 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-sm hover:shadow hover:-translate-y-0.5 active:translate-y-0">
                访问链接 <i data-lucide="external-link" class="w-3 h-3"></i>
             </a>
        </div>
      </div>
    </div>
    `;
}

function toggleCardDesc(id) {
    const textEl = document.getElementById(`${id}-text`);
    const btnEl = document.getElementById(`${id}-btn`);
    const isCollapsed = textEl.classList.contains('line-clamp-4');

    if (isCollapsed) {
        textEl.classList.remove('line-clamp-4');
        btnEl.innerHTML = `收起 <i data-lucide="chevron-up" class="w-3 h-3"></i>`;
    } else {
        textEl.classList.add('line-clamp-4');
        btnEl.innerHTML = `展开更多 <i data-lucide="chevron-down" class="w-3 h-3"></i>`;
    }
    lucide.createIcons();
}

/**
 * Back to Top Button
 */
function scrollToTop() {
    const contentArea = document.getElementById('content-area');
    if (contentArea) {
        contentArea.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function updateBackToTopButton() {
    const btn = document.getElementById('back-to-top-btn');
    if (!btn) return;
    
    const contentArea = document.getElementById('content-area');
    const scrollTop = contentArea ? contentArea.scrollTop : window.pageYOffset || document.documentElement.scrollTop;
    
    if (scrollTop > 300) {
        btn.style.opacity = '1';
        btn.style.pointerEvents = 'auto';
        btn.style.transform = 'translateY(0)';
    } else {
        btn.style.opacity = '0';
        btn.style.pointerEvents = 'none';
        btn.style.transform = 'translateY(10px)';
    }
}

/**
 * Event Listeners
 */
function initEventListeners() {
    const searchInput = document.getElementById('search-input');
    // Apply debounce to keyup/input events for search text
    searchInput.addEventListener('input', debouncedSearch);
    
    // Strict match checkbox listener
    const strictMatchCheckbox = document.getElementById('strict-match-checkbox');
    if (strictMatchCheckbox) {
        strictMatchCheckbox.addEventListener('change', (e) => {
            state.strictMatch = e.target.checked;
            saveStateToLocalStorage();
            executeSearch();
        });
    }
    
    // Back to top button scroll listener
    const contentArea = document.getElementById('content-area');
    if (contentArea) {
        contentArea.addEventListener('scroll', updateBackToTopButton);
    } else {
        window.addEventListener('scroll', updateBackToTopButton);
    }
    
    // Initial check for back to top button visibility
    updateBackToTopButton();
}

function toggleMobileMenu(show) {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobile-overlay');
    
    if (show) {
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
    } else {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
    }
}
</script>
</body>
</html>