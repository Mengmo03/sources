<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>B-HU资源beta 0.5</title>
    <script src="./assets/tailwind.css"></script>
    <!-- OpenCC -->
    <script src="./assets/full.js"></script>
    <!-- Lucide Icons -->
    <script src="./assets/lucide.min.js"></script>
    <!-- Busuanzi Stats -->
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <link rel="icon" href="./assets/icon.png" type="image/x-icon" />
    
    <style>
      @import url('https://gstatic.qaq.qa/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
      
      body {
        font-family: 'Inter', 'Noto Sans SC', sans-serif;
        background-color: #f8fafc;
        color: #1e293b;
        overscroll-behavior: none; 
      }

      /* Custom Scrollbar */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: #94a3b8;
      }

      /* Resource Description Links Styling (Boxed style) */
      .resource-desc a {
        display: inline-block;
        color: #4f46e5; /* indigo-600 */
        background-color: #f5f3ff; /* indigo-50 */
        border: 1px solid #c7d2fe; /* indigo-200 */
        padding: 2px 8px;
        margin: 0 2px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }

      .resource-desc a:hover {
        background-color: #4f46e5;
        color: #ffffff;
        border-color: #4f46e5;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
      }

      /* Tag Count Badge */
      .tag-count-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 1.5rem;
        height: 1.5rem;
        padding: 0 0.4rem;
        border-radius: 9999px;
        background-color: #f1f5f9;
        color: #64748b;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: auto; /* Push to right */
        border: 1px solid #e2e8f0;
      }
      
      /* Header Links Styling */
      .header-link {
        font-size: 0.8rem;
        color: #64748b;
        text-decoration: none;
        transition: color 0.2s;
        cursor: pointer;
      }
      .header-link:hover {
        color: #4f46e5;
        text-decoration: underline;
      }

      /* Utility for hiding elements */
      .hidden { display: none !important; }
      .rotate-90 { transform: rotate(90deg); }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-slate-50 gap-4">
        <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
        <p class="text-slate-500 font-medium animate-pulse">正在读取资源库...</p>
    </div>

    <!-- Error Screen -->
    <div id="error-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-50 p-4 hidden">
        <div class="bg-white p-8 rounded-xl shadow-xl max-w-md text-center border-l-4 border-rose-500">
            <i data-lucide="alert-circle" class="w-16 h-16 text-rose-500 mx-auto mb-4"></i>
            <h2 class="text-xl font-bold text-slate-800 mb-2">出错了</h2>
            <p id="error-message" class="text-slate-600 mb-6 leading-relaxed"></p>
            <button onclick="window.location.reload()" class="px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition-colors">
                重新加载页面
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="flex h-screen w-screen overflow-hidden bg-slate-50 text-slate-800 font-sans hidden">
        
        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="fixed inset-0 z-40 bg-slate-900/50 backdrop-blur-sm md:hidden transition-opacity hidden" onclick="toggleMobileMenu(false)"></div>

        <!-- SIDEBAR -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-80 bg-white border-r border-slate-200 shadow-2xl md:shadow-none transform transition-transform duration-300 ease-out flex flex-col -translate-x-full md:relative md:translate-x-0">
            <!-- Header -->
            <div class="h-16 flex items-center justify-between px-6 border-b border-slate-100 shrink-0 bg-white">
                <div class="flex items-center gap-2 text-indigo-700 font-bold text-xl tracking-tight">
                    <img src="./assets/icon.png" alt="Icon" class="w-5 h-5" />
                    <span>B-HU资源beta 0.5</span>
                </div>
                <button onclick="toggleMobileMenu(false)" class="md:hidden text-slate-400 hover:text-slate-600 p-1 hover:bg-slate-100 rounded-md">
                    <i data-lucide="x" size="20"></i>
                </button>
            </div>

            <!-- Tree Area -->
            <div id="tree-container" class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-0.5">
                <!-- Tree content injected by JS -->
            </div>

            <!-- Footer / Tag Supermarket -->
            <div class="border-t border-slate-200 bg-slate-50 p-4 shrink-0 shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)] z-10">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1">
                        <i data-lucide="tag" class="w-3 h-3"></i> <span id="selected-count">已选标签 (0)</span>
                    </span>
                    <button id="clear-btn" onclick="clearTags()" class="hidden text-xs text-rose-500 hover:text-rose-700 hover:bg-rose-50 px-2 py-1 rounded transition-colors flex items-center gap-1">
                        <i data-lucide="trash-2" class="w-3 h-3"></i> 清空
                    </button>
                </div>
                
                <div id="selected-tags-container" class="flex flex-wrap gap-y-1 gap-x-1 content-start overflow-y-auto custom-scrollbar min-h-[3rem] max-h-[8rem] mb-3 p-2 bg-white border border-slate-200 rounded-lg shadow-sm">
                    <div class="w-full h-full flex items-center justify-center text-slate-300 text-xs italic select-none">
                        查看所有资源...
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col min-w-0 h-full bg-slate-50/50 relative">
            
            <!-- Search Header -->
            <header class="h-auto py-3 bg-white/80 backdrop-blur-md border-b border-slate-200 px-4 md:px-8 flex items-start gap-4 sticky top-0 z-20">
                <button onclick="toggleMobileMenu(true)" class="md:hidden p-2 mt-1 -ml-2 text-slate-500 hover:bg-slate-100 rounded-lg transition-colors">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                
                <div class="relative flex-1 max-w-2xl flex flex-col gap-2">
                    <div class="relative w-full">
                        <i data-lucide="search" class="absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                        <input 
                            id="search-input"
                            type="text"
                            placeholder="在结果中搜索关键词... (支持繁简自动转换)"
                            class="w-full pl-11 pr-4 py-2.5 bg-slate-100 border-transparent focus:bg-white focus:border-indigo-300 focus:ring-4 focus:ring-indigo-50 rounded-xl text-sm transition-all outline-none"
                        />
                    </div>
                    
                    <!-- Extra Links -->
                    <div class="flex items-center justify-center gap-1 text-xs text-slate-400 select-none">
                        <a href="./index.html" target="_self" class="header-link">返回首页</a>
                        <span class="text-slate-300">|</span>
                        <a href="https://forms.office.com/r/AMncKSa0ZD" target="_blank" class="header-link">报告错误</a>
                        <span class="text-slate-300">|</span>
                        <a href="#" id="lang-toggle-btn" onclick="toggleLanguage(); return false;" class="header-link text-indigo-500 font-medium">English</a>
                    </div>
                </div>
                
                <div class="hidden lg:block text-xs text-slate-400 mt-3 text-right">
                    共收录 <span id="total-resource-count">0</span> 条资源<br>
                    <span id="total-tags-count">0</span> 个标签
                </div>
            </header>

            <!-- Content Area -->
            <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-8 custom-scrollbar flex flex-col">
                
                <!-- Welcome State -->
                <div id="welcome-view" class="flex-1 flex flex-col items-center justify-center text-center pb-10 select-none">
                    <img src="./assets/icon.png" alt="Icon" class="w-24 h-24 mb-8" />
                    <h1 class="text-3xl font-bold text-slate-800 mb-3">B-HU资源beta 0.5</h1>
                    <p class="text-slate-500 max-w-md mx-auto mb-6 leading-relaxed">
                        目前共收录 <span id="hero-resource-count" class="font-bold text-indigo-600">0</span> 条资源<br/>
                        涵盖 <span id="hero-tag-count" class="font-bold text-indigo-600">0</span> 个分类标签
                    </p>
                    <p class="text-slate-400 text-sm max-w-md mx-auto mb-8">
                        请在左侧勾选感兴趣的分类，或者输入关键词开始。
                    </p>
                    <button onclick="toggleMobileMenu(true)" class="md:hidden bg-white text-indigo-600 px-6 py-2.5 rounded-full font-medium shadow-md border border-indigo-100 hover:bg-indigo-50 flex items-center gap-2">
                        <i data-lucide="menu" class="w-4 h-4"></i>
                        打开分类菜单
                    </button>
                </div>

                <!-- Results View -->
                <div id="results-view" class="max-w-7xl mx-auto w-full flex-1 hidden">
                    <div class="flex items-end justify-between mb-6 border-b border-slate-200 pb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">搜索结果</h2>
                            <p id="search-status" class="text-sm text-slate-400 mt-1">全部资源</p>
                        </div>
                        <span id="result-count-badge" class="bg-indigo-50 px-3 py-1 rounded-full text-xs font-bold text-indigo-600">0 条</span>
                    </div>

                    <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-10">
                        <!-- Cards injected here -->
                    </div>

                    <!-- No Results -->
                    <div id="no-results" class="py-20 flex flex-col items-center justify-center text-center hidden">
                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                            <i data-lucide="search" class="text-slate-300 w-8 h-8"></i>
                        </div>
                        <h3 class="text-lg font-medium text-slate-700 mb-1">未找到结果</h3>
                        <p class="text-slate-400 text-sm">尝试选择其他分类或清除关键词</p>
                    </div>
                </div>

                <!-- Footer Stats -->
                <div class="mt-auto pt-8 pb-4 text-center border-t border-slate-200/60 w-full">
                    <span id="busuanzi_container_site_pv" style="font-family:Consolas;color:#94a3b8;font-size:12px;margin-right:1rem;">
                        访问量：<span id="busuanzi_value_site_pv" style="font-family:Consolas;color:#64748b;font-weight:600;"></span>
                    </span>
                    <span id="busuanzi_container_site_uv" style="font-family:Consolas;color:#94a3b8;font-size:12px;">
                        访问人数：<span id="busuanzi_value_site_uv" style="font-family:Consolas;color:#64748b;font-weight:600;"></span>
                    </span>
                </div>
            </div>
        </main>
    </div>

    <!-- Back to Top Button -->
    <button 
        id="back-to-top-btn" 
        onclick="scrollToTop()" 
        class="fixed bottom-6 right-6 z-50 p-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center opacity-0 pointer-events-none"
        style="width: 48px; height: 48px; transform: translateY(10px);"
        aria-label="返回顶部"
    >
        <i data-lucide="arrow-up" class="w-5 h-5"></i>
    </button>

<script>
/**
 * State Management
 */
const state = {
    treeData: [],
    csvData: [],
    selectedTags: new Set(),
    tagDescendants: new Map(),
    nodeCounts: new Map(), // Map<TagName, count>
    searchQuery: "",
    converter: null,
    expandedNodes: new Set() // Track expanded tree nodes by ID
};

/**
 * Utilities
 */
// Debounce function to limit search execution frequency
function debounce(func, wait) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
    };
}

/**
 * LocalStorage Management
 */
function saveStateToLocalStorage() {
    try {
        const savedState = {
            selectedTags: Array.from(state.selectedTags),
            searchQuery: state.searchQuery
        };
        localStorage.setItem('bhu-tree-state', JSON.stringify(savedState));
    } catch (e) {
        console.warn('Failed to save state to localStorage:', e);
    }
}

function loadStateFromLocalStorage() {
    try {
        const saved = localStorage.getItem('bhu-tree-state');
        if (saved) {
            const savedState = JSON.parse(saved);
            // Restore selected tags
            if (savedState.selectedTags && Array.isArray(savedState.selectedTags)) {
                state.selectedTags = new Set(savedState.selectedTags);
            }
            // Restore search query
            if (savedState.searchQuery) {
                state.searchQuery = savedState.searchQuery;
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = savedState.searchQuery;
                }
            }
            return true;
        }
    } catch (e) {
        console.warn('Failed to load state from localStorage:', e);
    }
    return false;
}

/**
 * Initialization
 */
document.addEventListener('DOMContentLoaded', async () => {
    lucide.createIcons();
    initOpenCC();
    initTranslate();
    
    try {
        await loadData();
        // Load state from localStorage before initializing UI
        loadStateFromLocalStorage();
        initEventListeners();
        renderTree(); // Initial render (collapsed)
        updateCounts();
        // Restore UI state after rendering
        updateSelectionUI();
        // Execute search to restore results if there's saved state
        if (state.selectedTags.size > 0 || state.searchQuery) {
            executeSearch();
        }
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        
        // Initialize back to top button icon after app is shown
        setTimeout(() => {
            lucide.createIcons();
            updateBackToTopButton();
        }, 100);
    } catch (e) {
        console.error(e);
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('error-screen').classList.remove('hidden');
        document.getElementById('error-message').textContent = "数据加载失败，请确保目录下存在 fenlei.md 和 data.csv";
    }
});

// Language Translation Logic
function initTranslate() {
    const script = document.createElement("script");
    script.src = "https://res.zvo.cn/translate/translate.js";
    script.defer = true;
    script.onload = () => {
        if (!window.translate) {
            console.error("Translate library loaded without exposing global.");
            return;
        }
        translate.setUseVersion2();
        translate.selectLanguageTag.show = false;
        // Set initial language to simplified chinese (local)
        translate.language.setLocal("chinese_simplified"); 
        translate.listener.start();
        window._translateReady = true;
    };
    script.onerror = () => {
        console.error("Failed to load translate.js");
    };
    document.head.appendChild(script);
}

function toggleLanguage() {
    if (!window.translate || !window._translateReady) {
        alert("页面翻译功能还在加载，请稍后再试。");
        return;
    }

    const btn = document.getElementById('lang-toggle-btn');
    const currentLang = translate.language.getLocal();

    if (currentLang === 'chinese_simplified') {
        translate.changeLanguage('english');
        btn.textContent = '简体中文';
    } else {
        translate.changeLanguage('chinese_simplified');
        btn.textContent = 'English';
    }
}

async function initOpenCC() {
    if (window.OpenCC) {
        try {
            const cvtS2T = await window.OpenCC.Converter({ from: 'cn', to: 'hk' });
            const cvtT2S = await window.OpenCC.Converter({ from: 'hk', to: 'cn' });
            state.converter = { s2t: cvtS2T, t2s: cvtT2S };
        } catch (e) {
            console.warn("OpenCC init failed", e);
        }
    }
}

function updateCounts() {
    const totalRes = state.csvData.length;
    const totalTags = countTreeNodes(state.treeData);
    document.getElementById('total-resource-count').textContent = totalRes;
    document.getElementById('total-tags-count').textContent = totalTags;
    document.getElementById('hero-resource-count').textContent = totalRes;
    document.getElementById('hero-tag-count').textContent = totalTags;
}

function countTreeNodes(nodes) {
    let count = 0;
    nodes.forEach(node => {
        count++; // Count self
        if (node.children && node.children.length > 0) {
            count += countTreeNodes(node.children);
        }
    });
    return count;
}

/**
 * Data Parsing & Loading
 */
async function loadData() {
    const [mdRes, csvRes] = await Promise.all([
        fetch("./data/fenlei.md"),
        fetch("./data/data.csv")
    ]);

    if (!mdRes.ok || !csvRes.ok) throw new Error("Failed to fetch data files");

    const mdText = await mdRes.text();
    const csvText = await csvRes.text();

    state.treeData = parseMarkdownTree(mdText);
    state.csvData = parseCSV(csvText);
    state.tagDescendants = buildDescendantMap(state.treeData);
    
    // Calculate recursive counts for tree visualization
    state.nodeCounts = calculateRecursiveCounts(state.treeData, state.csvData);
}

function calculateRecursiveCounts(treeData, csvData) {
    // 1. Map direct counts: TagName -> Set of indices
    const tagDirectItems = new Map();
    
    csvData.forEach((item, index) => {
        if (item.tags) {
            item.tags.forEach(tag => {
                if (!tagDirectItems.has(tag)) {
                    tagDirectItems.set(tag, new Set());
                }
                tagDirectItems.get(tag).add(index);
            });
        }
    });

    // 2. Recursive aggregation
    const counts = new Map();

    function processNode(nodes) {
        const branchItems = new Set(); // Items in this branch (self + children)

        nodes.forEach(node => {
            const nodeItems = new Set(tagDirectItems.get(node.name) || []);
            
            if (node.children && node.children.length > 0) {
                const childItems = processNode(node.children);
                childItems.forEach(i => nodeItems.add(i));
            }

            // Store the unique count for this node (including its children)
            counts.set(node.name, nodeItems.size);

            // Add to parent branch
            nodeItems.forEach(i => branchItems.add(i));
        });

        return branchItems;
    }

    processNode(treeData);
    return counts;
}

function parseMarkdownTree(md) {
    const normalizedMd = md.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
    const lines = normalizedMd.split("\n");
    const root = [];
    const stack = [];

    lines.forEach((line, index) => {
        if (!line.trim()) return;
        const match = line.match(/^([\t ]*)([-*+])\s+(.+)$/);
        if (!match) return;

        const rawIndent = match[1];
        const indent = rawIndent.replace(/\t/g, "    ").length;
        let rawContent = match[3].trim();
        let name = rawContent;
        let comment = "";

        const commentMatch = rawContent.match(/<!--([\s\S]*?)-->/);
        if (commentMatch) {
            let cText = commentMatch[1].trim();
            if (cText.startsWith("注释:{") && cText.endsWith("}")) {
                cText = cText.substring(4, cText.length - 1);
            }
            comment = cText;
            name = rawContent.replace(/<!--[\s\S]*?-->/, "").trim();
        }

        if (!name) return;

        const node = {
            id: `node-${index}`,
            name,
            comment,
            children: [],
            level: 0
        };

        while (stack.length > 0 && stack[stack.length - 1].indent >= indent) {
            stack.pop();
        }

        if (stack.length === 0) {
            root.push(node);
            node.level = 0;
        } else {
            const parent = stack[stack.length - 1].node;
            parent.children.push(node);
            node.level = parent.level + 1;
        }

        stack.push({ node, indent });
    });
    return root;
}

function parseCSV(csv) {
    const lines = csv.split(/\r?\n/).filter(line => line.trim() !== "");
    if (lines.length === 0) return [];

    const parseLine = (line) => {
        const result = [];
        let current = "";
        let inQuote = false;
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
                inQuote = !inQuote;
            } else if (char === ',' && !inQuote) {
                result.push(current.trim());
                current = "";
            } else {
                current += char;
            }
        }
        result.push(current.trim());
        return result;
    };

    const headers = parseLine(lines[0]).map(h => h.toLowerCase().replace(/^[\uFEFF]/, '').trim());
    const tagsIndex = headers.findIndex(h => h.includes("tag") || h.includes("fenlei") || h.includes("分类"));

    return lines.slice(1).map(line => {
        const values = parseLine(line);
        const item = {};
        headers.forEach((header, index) => {
            let value = values[index] || "";
            if (value.startsWith('"') && value.endsWith('"')) value = value.slice(1, -1);
            item[header] = value;
        });

        let rawTags = tagsIndex !== -1 ? values[tagsIndex] : "";
        if (!rawTags) rawTags = "";
        item.tags = rawTags.replace(/[\[\]"]/g, "").split(/[,，、]/).map(t => t.trim()).filter(t => t.length > 0);
        
        // PRE-PROCESS SEARCH STRING for performance
        // Concatenate title, desc, tags and lowercase them once.
        const title = (item.title || item.name || Object.values(item)[0] || "");
        const desc = (item.description || item.desc || "");
        const tagStr = item.tags.join(" ");
        item._searchStr = `${title} ${desc} ${tagStr}`.toLowerCase();
        
        return item;
    });
}

function buildDescendantMap(nodes) {
    const map = new Map();
    const traverse = (node) => {
        const descendants = new Set();
        node.children.forEach(child => {
            descendants.add(child.name);
            const childDescendants = traverse(child);
            childDescendants.forEach(d => descendants.add(d));
        });
        map.set(node.name, descendants);
        return descendants;
    };
    nodes.forEach(node => traverse(node));
    return map;
}

/**
 * UI Rendering: Sidebar Tree
 */
function renderTree() {
    const container = document.getElementById('tree-container');
    
    // Use DocumentFragment for performance
    const fragment = document.createDocumentFragment();

    // 'All' Node
    const allSelected = state.selectedTags.size === 0;
    const allNode = document.createElement('div');
    allNode.innerHTML = `
        <div class="flex items-center py-2 px-2 rounded-md transition-all duration-200 hover:bg-slate-100 cursor-pointer mb-2 ${allSelected ? 'bg-indigo-50/50' : ''}">
            <div class="w-4 mr-1"></div>
            <div class="mr-2 ${allSelected ? 'text-indigo-600' : 'text-slate-400'}">
                <i data-lucide="${allSelected ? 'check-square' : 'square'}" class="w-4 h-4"></i>
            </div>
            <div class="font-bold ${allSelected ? 'text-indigo-700' : 'text-slate-800'}">全部</div>
        </div>
        <div class="border-b border-slate-100 my-2"></div>
    `;
    // Bind click directly
    allNode.firstElementChild.onclick = () => clearTags();
    fragment.appendChild(allNode);

    // Recursive Tree
    state.treeData.forEach(node => {
        fragment.appendChild(createTreeNode(node));
    });

    container.innerHTML = '';
    container.appendChild(fragment);

    lucide.createIcons();
}

function createTreeNode(node) {
    const isSelected = state.selectedTags.has(node.name);
    const isExpanded = state.expandedNodes.has(node.id);
    const hasChildren = node.children && node.children.length > 0;
    const count = state.nodeCounts.get(node.name) || 0;
    
    const wrapper = document.createElement('div');
    wrapper.className = "select-none text-sm mb-1";

    // Node Row
    const row = document.createElement('div');
    row.className = "relative group";
    row.style.marginLeft = `${node.level * 16}px`;

    const inner = document.createElement('div');
    inner.className = `flex items-start py-1.5 px-2 rounded-md transition-all duration-200 hover:bg-slate-100 ${isSelected ? 'bg-indigo-50/50' : ''}`;

    // Toggle Expand Handler
    const toggleExpand = (e) => {
        if (e && e.target && e.target.closest('.tree-checkbox-container')) {
            // Don't expand if clicking on checkbox
            return;
        }
        if (hasChildren) {
            if (state.expandedNodes.has(node.id)) {
                state.expandedNodes.delete(node.id);
            } else {
                state.expandedNodes.add(node.id);
            }
            renderTree(); 
        }
    };

    // Toggle Select Handler
    const toggleSelect = (e) => {
        if (e) {
            e.stopPropagation();
            e.preventDefault();
        }
        toggleTag(node.name);
    };

    // Make the entire inner div clickable for expand/collapse (except checkbox)
    // If no children, clicking will toggle selection instead
    inner.onclick = hasChildren ? toggleExpand : toggleSelect;
    inner.style.cursor = hasChildren ? 'pointer' : 'pointer';

    // Chevron
    const chevronContainer = document.createElement('div');
    chevronContainer.className = `mr-1 text-slate-400 transition-transform duration-200 hover:text-slate-600 flex-shrink-0 flex items-start pt-0.5 ${isExpanded ? 'rotate-90' : ''} ${hasChildren ? '' : 'opacity-0 pointer-events-none'}`;
    chevronContainer.innerHTML = `<i data-lucide="chevron-right" class="w-4 h-4"></i>`;
    // Remove individual onclick since inner div handles it

    // Checkbox
    const checkboxContainer = document.createElement('div');
    checkboxContainer.className = `tree-checkbox-container mr-2 cursor-pointer flex-shrink-0 transition-colors flex items-start pt-0.5 ${isSelected ? 'text-indigo-600' : 'text-slate-300 hover:text-indigo-400'}`;
    checkboxContainer.innerHTML = `<i data-lucide="${isSelected ? 'check-square' : 'square'}" class="w-4 h-4"></i>`;
    checkboxContainer.onclick = toggleSelect;

    // Content
    const content = document.createElement('div');
    content.className = "flex flex-1 items-start min-w-0 mr-2";
    
    const title = document.createElement('span');
    title.className = `font-medium leading-5 break-words ${isSelected ? 'text-indigo-700' : 'text-slate-700'}`;
    title.textContent = node.name;
    // Remove individual onclick since inner div handles it

    content.appendChild(title);

    // Count Badge
    const countBadge = document.createElement('span');
    countBadge.className = "tag-count-badge flex-shrink-0 mt-0.5";
    countBadge.textContent = count;
    
    inner.appendChild(chevronContainer);
    inner.appendChild(checkboxContainer);
    inner.appendChild(content);
    inner.appendChild(countBadge);

    row.appendChild(inner);
    wrapper.appendChild(row);

    // Comments (Render below row if exists)
    if (node.comment) {
        const comment = document.createElement('div');
        comment.className = "text-xs text-slate-500 mt-1 mb-1 pl-2";
        comment.style.marginLeft = `${(node.level * 16) + 24}px`;
        comment.style.lineHeight = '1.5';
        // Parse HTML tags in comment and preserve line breaks
        const commentHtml = node.comment.replace(/\n/g, '<br/>');
        comment.innerHTML = commentHtml;
        wrapper.appendChild(comment);
    }

    // Children
    if (isExpanded && hasChildren) {
        const childrenContainer = document.createElement('div');
        childrenContainer.className = "mt-0.5";
        node.children.forEach(child => {
            childrenContainer.appendChild(createTreeNode(child));
        });
        wrapper.appendChild(childrenContainer);
    }

    return wrapper;
}

/**
 * Logic: Selection & Search
 */
function toggleTag(tag) {
    if (state.selectedTags.has(tag)) {
        state.selectedTags.delete(tag);
    } else {
        state.selectedTags.add(tag);
    }
    saveStateToLocalStorage(); // Save to localStorage
    updateSelectionUI();
    executeSearch(); // Trigger search immediately
}

function clearTags() {
    state.selectedTags.clear();
    saveStateToLocalStorage(); // Save to localStorage
    updateSelectionUI();
    executeSearch(); // Trigger search immediately
}

function updateSelectionUI() {
    renderTree();
    
    const container = document.getElementById('selected-tags-container');
    const countSpan = document.getElementById('selected-count');
    const clearBtn = document.getElementById('clear-btn');

    countSpan.textContent = `已选标签 (${state.selectedTags.size})`;
    
    if (state.selectedTags.size === 0) {
        container.innerHTML = `<div class="w-full h-full flex items-center justify-center text-slate-300 text-xs italic select-none">查看所有资源...</div>`;
        clearBtn.classList.add('hidden');
    } else {
        clearBtn.classList.remove('hidden');
        container.innerHTML = '';
        state.selectedTags.forEach(tag => {
            const chip = document.createElement('span');
            chip.className = "inline-flex items-center bg-indigo-50 text-indigo-700 text-xs font-medium px-2.5 py-1 rounded-md mr-2 mb-2 border border-indigo-100 group hover:bg-indigo-100 transition-colors";
            chip.innerHTML = `
                ${tag}
                <button class="ml-1.5 text-indigo-400 hover:text-indigo-800 focus:outline-none" onclick="toggleTag('${tag}')">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            `;
            container.appendChild(chip);
        });
        lucide.createIcons();
    }
}

// Debounced search execution
const debouncedSearch = debounce(() => {
    executeSearch();
}, 300);

async function executeSearch() {
    // Mobile close if needed (optional logic check could be added here to only close if query is distinct)
    // if (window.innerWidth < 768) toggleMobileMenu(false);

    const input = document.getElementById('search-input');
    const rawQuery = input.value.trim();
    state.searchQuery = rawQuery;
    saveStateToLocalStorage(); // Save to localStorage

    // If no tags and no query, show welcome screen
    if (state.selectedTags.size === 0 && !rawQuery) {
        document.getElementById('welcome-view').classList.remove('hidden');
        document.getElementById('results-view').classList.add('hidden');
        return;
    }

    // Effective Tags (Parent includes children)
    const effectiveTags = new Set();
    state.selectedTags.forEach(t => {
        effectiveTags.add(t);
        const children = state.tagDescendants.get(t);
        if (children) children.forEach(child => effectiveTags.add(child));
    });

    // Keyword handling (OpenCC)
    let searchTerms = [];
    if (rawQuery) {
        // Use basic lowercase first
        searchTerms.push(rawQuery.toLowerCase());
        // Attempt OpenCC if available
        if (state.converter) {
            try {
                const s2t = await state.converter.s2t(rawQuery);
                const t2s = await state.converter.t2s(rawQuery);
                if (s2t !== rawQuery) searchTerms.push(s2t.toLowerCase());
                if (t2s !== rawQuery) searchTerms.push(t2s.toLowerCase());
            } catch(e) { console.error(e); }
        }
    }
    // Remove duplicates
    searchTerms = [...new Set(searchTerms)];

    // Filter (Optimized Loop)
    const hasTags = state.selectedTags.size > 0;
    const hasQuery = searchTerms.length > 0;

    const results = state.csvData.filter(item => {
        // 1. Tag Match (Fastest check first)
        if (hasTags) {
            if (!item.tags || item.tags.length === 0) return false;
            // Using effectiveTags Set for O(1) lookup per tag
            const matchesTag = item.tags.some(t => effectiveTags.has(t));
            if (!matchesTag) return false;
        }

        // 2. Keyword Match
        if (hasQuery) {
            // item._searchStr is pre-computed lowercase string
            const matchesKeyword = searchTerms.some(term => item._searchStr.includes(term));
            if (!matchesKeyword) return false;
        }

        return true;
    });

    renderResults(results);
}

/**
 * UI Rendering: Results
 */
function renderResults(results) {
    document.getElementById('welcome-view').classList.add('hidden');
    document.getElementById('results-view').classList.remove('hidden');

    const grid = document.getElementById('results-grid');
    const noResults = document.getElementById('no-results');
    const badge = document.getElementById('result-count-badge');
    const status = document.getElementById('search-status');

    badge.textContent = `${results.length} 条`;
    
    let statusText = state.selectedTags.size > 0 ? `包含标签: ${Array.from(state.selectedTags).join(", ")}` : "全部资源";
    if (state.searchQuery) statusText += ` + 关键词: "${state.searchQuery}"`;
    status.textContent = statusText;

    if (results.length === 0) {
        grid.innerHTML = '';
        noResults.classList.remove('hidden');
    } else {
        noResults.classList.add('hidden');
        
        // CRITICAL PERFORMANCE FIX: Map to strings then join, set innerHTML once
        // This avoids N reflows/repaints
        const htmlBuffer = results.map(item => generateCardHtml(item));
        grid.innerHTML = htmlBuffer.join('');
        
        // Only create icons after bulk insertion
        lucide.createIcons();
    }
}

function generateCardHtml(item) {
    const title = item.title || item.name || Object.values(item)[0] || "无标题";
    const desc = item.description || item.desc || item.summary || "";
    const link = item.link || item.url || "#";
    const safeLink = link.startsWith("http") ? link : `http://${link}`;
    const tags = item.tags || [];
    
    // Heuristic for long text (approx 100 chars)
    const isLongText = desc.length > 100;
    // Random ID only generated when needed, or use a deterministic one if preferred
    const cardId = 'card-' + Math.random().toString(36).substr(2, 9);

    let tagsHtml = tags.length > 0 
        ? tags.slice(0,3).map(t => `<span class="text-[10px] font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded whitespace-nowrap border border-slate-200">${t}</span>`).join('')
        : `<span class="text-[10px] text-slate-300">无标签</span>`;
    
    if (tags.length > 3) tagsHtml += `<span class="text-[10px] text-slate-400 py-1">+ ${tags.length - 3}</span>`;

    return `
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-md hover:border-indigo-300 transition-all duration-300 flex flex-col h-full overflow-hidden group">
      <div class="p-5 flex-1 flex flex-col">
        <div class="flex justify-between items-start gap-3 mb-2">
          <h3 class="font-bold text-slate-800 text-lg leading-snug select-text">${title}</h3>
        </div>
        
        <div class="flex-1 mb-4">
            ${desc ? `
                <div>
                    <div id="${cardId}-text" class="resource-desc text-slate-500 text-sm leading-relaxed text-justify select-text break-words line-clamp-4">
                        ${desc}
                    </div>
                    ${isLongText ? `
                        <button onclick="toggleCardDesc('${cardId}')" id="${cardId}-btn" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium mt-2 flex items-center gap-0.5 focus:outline-none transition-colors p-1 hover:bg-indigo-50 rounded">
                            展开更多 <i data-lucide="chevron-down" class="w-3 h-3"></i>
                        </button>
                    ` : ''}
                </div>
            ` : `<p class="text-slate-300 text-sm italic">暂无描述</p>`}
        </div>

        <div class="mt-auto pt-4 border-t border-slate-100 flex items-end justify-between gap-3">
             <div class="flex flex-wrap gap-1.5 flex-1 min-w-0">
                ${tagsHtml}
             </div>
             <a href="${safeLink}" target="_blank" rel="noreferrer" class="shrink-0 flex items-center gap-1.5 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-sm hover:shadow hover:-translate-y-0.5 active:translate-y-0">
                访问链接 <i data-lucide="external-link" class="w-3 h-3"></i>
             </a>
        </div>
      </div>
    </div>
    `;
}

function toggleCardDesc(id) {
    const textEl = document.getElementById(`${id}-text`);
    const btnEl = document.getElementById(`${id}-btn`);
    const isCollapsed = textEl.classList.contains('line-clamp-4');

    if (isCollapsed) {
        textEl.classList.remove('line-clamp-4');
        btnEl.innerHTML = `收起 <i data-lucide="chevron-up" class="w-3 h-3"></i>`;
    } else {
        textEl.classList.add('line-clamp-4');
        btnEl.innerHTML = `展开更多 <i data-lucide="chevron-down" class="w-3 h-3"></i>`;
    }
    lucide.createIcons();
}

/**
 * Back to Top Button
 */
function scrollToTop() {
    const contentArea = document.getElementById('content-area');
    if (contentArea) {
        contentArea.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function updateBackToTopButton() {
    const btn = document.getElementById('back-to-top-btn');
    if (!btn) return;
    
    const contentArea = document.getElementById('content-area');
    const scrollTop = contentArea ? contentArea.scrollTop : window.pageYOffset || document.documentElement.scrollTop;
    
    if (scrollTop > 300) {
        btn.style.opacity = '1';
        btn.style.pointerEvents = 'auto';
        btn.style.transform = 'translateY(0)';
    } else {
        btn.style.opacity = '0';
        btn.style.pointerEvents = 'none';
        btn.style.transform = 'translateY(10px)';
    }
}

/**
 * Event Listeners
 */
function initEventListeners() {
    const searchInput = document.getElementById('search-input');
    // Apply debounce to keyup/input events for search text
    searchInput.addEventListener('input', debouncedSearch);
    
    // Back to top button scroll listener
    const contentArea = document.getElementById('content-area');
    if (contentArea) {
        contentArea.addEventListener('scroll', updateBackToTopButton);
    } else {
        window.addEventListener('scroll', updateBackToTopButton);
    }
    
    // Initial check for back to top button visibility
    updateBackToTopButton();
}

function toggleMobileMenu(show) {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobile-overlay');
    
    if (show) {
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
    } else {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
    }
}
</script>
</body>
</html>