<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="./assets/icon.png" type="image/x-icon" />
    <title>B-HU 资源beta 0.5</title>
    <link rel="stylesheet" href="assets/pie-web.css" />
    <style>
      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: #f8fafc;
      }
      .markdown-shell {
        width: min(960px, 100%);
        margin: 0 auto;
        padding: 2rem clamp(1rem, 4vw, 3rem) 4rem;
        flex: 1;
      }
    </style>
    <script src="assets/marked.min.js"></script>
  </head>
  <body>
    <script>
      (function setupTranslate() {
        const script = document.createElement("script");
        script.src = "https://res.zvo.cn/translate/translate.js";
        script.defer = true;
        script.onload = () => {
          if (!window.translate) {
            console.warn("Translate library loaded without exposing global.");
            return;
          }
          try {
            translate.setUseVersion2();
            translate.selectLanguageTag.show = false;
            translate.language.setLocal("chinese_simplified");
            translate.listener.start();
            window.setTimeout(() => {
              try {
                translate.execute();
              } catch (e) {
                console.warn("Translate execute failed:", e);
              }
            }, 1000);
            window._translateReady = true;
          } catch (e) {
            console.warn("Translate initialization failed:", e);
          }
        };
        script.onerror = () => {
          console.warn("Failed to load translate.js, translation feature disabled");
          // 不阻塞页面，只是禁用翻译功能
        };
        document.head.appendChild(script);
      })();

      window.handleLanguageChange = (lang) => {
        if (window.translate && typeof translate.changeLanguage === "function") {
          try {
            translate.changeLanguage(lang);
          } catch (e) {
            console.warn("Language change failed:", e);
          }
        } else {
          console.warn("Translation library not ready yet.");
          // 不显示 alert，避免在离线时打扰用户
          if (window._translateReady !== false) {
            console.warn("Translation feature unavailable");
          }
        }
      };
    </script>
    <main class="markdown-shell">
      <article id="content" class="markdown-body"></article>
      <!--不蒜子-->
    <script>
      (function() {
        const script = document.createElement("script");
        script.async = true;
        script.src = "//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js";
        script.onerror = () => {
          console.warn("Busuanzi stats failed to load, statistics feature disabled");
          // 隐藏统计显示区域，避免显示空白
          const containers = document.querySelectorAll('[id^="busuanzi_container"]');
          containers.forEach(el => el.style.display = 'none');
        };
        document.head.appendChild(script);
      })();
    </script>
    <div style="text-align: center;">
        <span id="busuanzi_container_site_pv" style="font-family:Consolas;color:rgba(21,170,191,.6);font-size:12px;">
            访问量：<span id="busuanzi_value_site_pv" style="font-family:Consolas;color:Silver;font-size:12px;"></span>
        </span>
        <span id="busuanzi_container_site_uv" style="font-family:Consolas;color:rgba(21,170,191,.6);font-size:12px;">
            访问人数：<span id="busuanzi_value_site_uv" style="font-family:Consolas;color:Silver;font-size:12px;"></span>
        </span>
    </div>
    <script>
      // 第二个翻译脚本（如果第一个失败，尝试这个）
      (function() {
        if (window._translateReady) return; // 如果第一个已经成功，跳过
        
        const script = document.createElement("script");
        script.src = "https://res.zvo.cn/translate/translate.js";
        script.onload = () => {
          if (window.translate && typeof translate.setUseVersion2 === "function") {
            try {
              translate.setUseVersion2();
              translate.selectLanguageTag.show = false;
              translate.language.setLocal('chinese_simplified');
              translate.listener.start();
              window.onload = function() {
                setTimeout(function() {
                  try {
                    translate.execute();
                  } catch (e) {
                    console.warn("Translate execute failed:", e);
                  }
                }, 1000);
              };
            } catch (e) {
              console.warn("Translate initialization failed:", e);
            }
          }
        };
        script.onerror = () => {
          console.warn("Second translate script failed to load");
        };
        document.head.appendChild(script);
      })();
    </script>
    </main>
    <script>
      (function () {
        const contentEl = document.getElementById("content");

        function getHashPath() {
          const hash = window.location.hash;
          if (!hash || hash === "#" || hash === "#/") {
            return "index";
          }
          // 移除 # 和开头的 /，例如 #/index -> index, #/pages/xxx -> pages/xxx
          return hash.replace(/^#\/?/, "").trim() || "index";
        }

        function resolveTargetPath(rawPage) {
          const safeName = (rawPage || "index").trim();
          if (!safeName || safeName === "index") {
            return "README.md";
          }
          // 如果路径已经包含 .md，直接返回
          if (safeName.endsWith(".md")) {
            return safeName;
          }
          // 否则尝试在 pages 目录下查找
          return `pages/${safeName}.md`;
        }

        function updateTitle(fallback, override) {
          const heading = contentEl.querySelector("h1");
          if (heading && heading.textContent.trim()) {
            document.title = heading.textContent.trim();
          } else {
            document.title = override || fallback;
          }
        }

        async function loadMarkdown() {
          const hashPath = getHashPath();
          const targetPath = resolveTargetPath(hashPath);

          try {
            const response = await fetch(`${targetPath}?t=${Date.now()}`);
            if (!response.ok) {
              throw new Error(`${response.status} ${response.statusText}`);
            }
            const source = await response.text();
            contentEl.innerHTML = marked.parse(source, {
              mangle: false,
              headerIds: true,
            });
            updateTitle("Markdown 查看器");
          } catch (error) {
            console.warn("Failed to load markdown from network, trying cache:", error);
            
            // 离线回退：尝试从 Service Worker 缓存读取
            try {
              const cache = await caches.open('bhu-resource-v1');
              const cachedResponse = await cache.match(`./${targetPath}`);
              if (cachedResponse) {
                const source = await cachedResponse.text();
                contentEl.innerHTML = marked.parse(source, {
                  mangle: false,
                  headerIds: true,
                });
                updateTitle("Markdown 查看器");
                console.log(`Loaded ${targetPath} from cache`);
                return;
              }
            } catch (cacheError) {
              console.warn("Failed to load from cache:", cacheError);
            }
            
            // 如果加载失败且不是 README.md，则回退到 README.md
            if (targetPath !== "README.md") {
              try {
                const fallbackResponse = await fetch(`README.md?t=${Date.now()}`);
                if (fallbackResponse.ok) {
                  const fallbackSource = await fallbackResponse.text();
                  contentEl.innerHTML = marked.parse(fallbackSource, {
                    mangle: false,
                    headerIds: true,
                  });
                  updateTitle("Markdown 查看器");
                  return;
                }
              } catch (fallbackError) {
                // 尝试从缓存读取 README.md
                try {
                  const cache = await caches.open('bhu-resource-v1');
                  const cachedIndex = await cache.match('./README.md');
                  if (cachedIndex) {
                    const source = await cachedIndex.text();
                    contentEl.innerHTML = marked.parse(source, {
                      mangle: false,
                      headerIds: true,
                    });
                    updateTitle("Markdown 查看器");
                    console.log('Loaded README.md from cache as fallback');
                    return;
                  }
                } catch (cacheError2) {
                  console.warn("Failed to load README.md from cache:", cacheError2);
                }
                console.warn("Fallback to README.md also failed:", fallbackError);
              }
            }
            // 如果所有方法都失败，显示错误信息
            contentEl.innerHTML = "<p style='text-align:center;color:#64748b;padding:2rem;'>内容加载失败，请检查网络连接或刷新页面重试。</p>";
            updateTitle("Markdown 查看器", "加载失败");
          }
        }

        // 初始加载
        loadMarkdown();

        // 监听 hash 变化
        window.addEventListener("hashchange", loadMarkdown);
      })();
    </script>
  </body>
</html>
